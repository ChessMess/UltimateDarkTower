<!DOCTYPE html>
<html lang="en" class="tower-controller-bg min-h-screen">

<head>
  <meta charset="utf-8">
  <title>UDT Controller</title>
  <meta name="UDT Controller"
    content="example tower controller using the ultimate dark tower library for Return To Dark Tower">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* Custom font for tower controller */
    @font-face {
      font-family: 'azkolskerning7';
      src: url('../assets/azkolskerning7-webfont.woff2') format('woff2'),
        url('../assets/azkolskerning7-webfont.woff') format('woff');
      font-weight: normal;
      font-style: normal;
    }

    /* Custom background for the tower controller */
    .tower-controller-bg {
      background-image: url('../assets/background.jpeg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    /* Custom log styles */
    .log-line {
      margin: 2px 0;
      padding: 1px 4px;
      border-left: 4px solid transparent;
    }

    .log-debug {
      color: #6b7280;
      border-left-color: #9ca3af;
    }

    .log-info {
      color: #1f2937;
      border-left-color: #3b82f6;
    }

    .log-warn {
      color: #c2410c;
      border-left-color: #f97316;
      background-color: #fefbf3;
    }

    .log-error {
      color: #b91c1c;
      border-left-color: #ef4444;
      background-color: #fdf2f2;
    }

    .log-error {
      color: #b91c1c;
      border-left-color: #ef4444;
      background-color: #fdf2f2;
    }

    /* Custom component classes to reduce duplication */
    .tower-button {
      background-color: #374151;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
    }

    .tower-button:hover {
      background-color: #4b5563;
    }

    .tower-select {
      background-color: rgba(55, 65, 81, 0.6);
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
    }

    .tower-fieldset {
      background-color: rgba(0, 0, 0, 0.6);
      border: 1px solid #9ca3af;
      border-radius: 0.375rem;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .tower-legend {
      padding: 0 0.5rem;
      color: white;
    }

    .tower-checkbox {
      width: 1rem;
      height: 1rem;
    }

    .tower-table-cell {
      padding: 0.25rem 0.5rem;
    }

    .tower-table-cell-sm {
      padding: 0.25rem 0.25rem;
    }

    .tower-table-header {
      padding: 0.25rem 0.5rem;
      font-weight: bold;
    }

    .tower-hr {
      margin: 0.5rem 0;
      border-color: #9ca3af;
    }

    .tower-link {
      color: #f97316;
      transition: color 0.15s ease-in-out;
    }

    .tower-link:hover {
      color: #fb923c;
    }

    .nested-fieldset {
      border: 1px solid #9ca3af;
      border-radius: 0.25rem;
      padding: 0.5rem;
      width: fit-content;
    }

    .seal-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      padding: 0.25rem;
      width: fit-content;
    }

    .seal-square {
      width: 1rem;
      height: 1rem;
      background-color: #d1d5db;
      border-radius: 0.25rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      border: 1px solid transparent;
    }

    .seal-square:hover {
      background-color: #9ca3af;
      border-color: #6b7280;
    }

    .seal-square.broken {
      background-color: #991b1b;
    }

    .seal-square.broken:hover {
      background-color: #b91c1c;
    }

    /* Glyph grid cell styles */
    .glyph-cell {
      width: 2rem;
      height: 2rem;
      background-color: #4b5563;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #6b7280;
      transition: all 0.2s ease-in-out;
    }

    .glyph-cell:hover {
      background-color: #6b7280;
      border-color: #9ca3af;
    }

    .glyph-cell img {
      width: 1.5rem;
      height: 1.5rem;
      filter: brightness(0) invert(1);
    }

    /* Material Design Tab interface styles */
    .tower-tabs {
      display: flex;
      width: 100%;
      background-color: rgba(15, 23, 42, 0.8);
      border-radius: 0.5rem;
      padding: 0.25rem;
      margin-bottom: 1rem;
      border: 1px solid #334155;
    }

    .tower-tab-button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      color: #64748b;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s ease-in-out;
      border-radius: 0.375rem;
      z-index: 10;
      position: relative;
    }

    .tower-tab-button:hover {
      color: #cbd5e1;
      background-color: rgba(51, 65, 85, 0.5);
    }

    .tower-tab-button.tower-tab-active {
      color: #f97316;
      background-color: rgba(249, 115, 22, 0.15);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(249, 115, 22, 0.3);
    }

    .tower-tab-content {
      display: none;
    }

    .tower-tab-content.tower-tab-content-active {
      display: block;
    }

    /* Align left column tabs with right column content */
    .tower-left-column {
      margin-top: 0.5rem;
    }
  </style>

  <!-- Scripts (also at bottom of page) -->
  <script src="TowerController.js"></script>
</head>

<body class="font-roboto text-white min-h-screen">
  <div id="container" class="max-w-6xl mx-auto mt-3 border-2 border-yellow-500">
    <div class="inner bg-black bg-opacity-60 p-3">
      <div id="content">
        <div class="text-center">
          <h1 class="text-5xl font-light my-1" style="font-family: 'azkolskerning7', serif;">Tower Controller</h1>
          <h3 class="text-center text-lg font-light">
            A web based tower controller for
            <a target="_blank" href="https://restorationgames.com/return-to-dark-tower/" class="tower-link">
              Return To Dark Tower </a>
          </h3>

        </div>
        <hr class="tower-hr" />
        <div id="tower-connection-state" class="text-center">
          Turn on your Tower and press the Connect button
        </div>
        <hr class="tower-hr" />
        <div class="text-center pb-2 space-x-4">
          <button id="connectButton" onclick="connectToTower()" class="tower-button">Connect</button>
          <button id="disconnectButton" onclick="Tower.disconnect()" class="tower-button">Disconnect</button>
          <button id="calibrate" onclick="calibrate()" class="tower-button">Calibrate</button>
          <span class="hidden ml-2" id="calibrating-message">calibrating...</span>
        </div>
        <hr class="tower-hr" />

        <!-- Two-column layout for fieldsets -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 items-start">
          <!-- Left Column -->
          <div class="space-y-3 tower-left-column">
            <!-- Tab Navigation -->
            <div class="tower-tabs">
              <button id="diagnostics-tab" class="tower-tab-button tower-tab-active" onclick="switchTab('diagnostics')">
                Diagnostics
              </button>
              <button id="library-tab" class="tower-tab-button" onclick="switchTab('library')">
                Library
              </button>
            </div>

            <!-- Diagnostics Tab Content -->
            <div id="diagnostics-content" class="tower-tab-content tower-tab-content-active">
              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Audio</legend>
                <div class="flex justify-evenly items-center p-1 space-x-4">
                  <select id="sounds" class="tower-select w-3/4">
                    <option value="0">select sound</option>
                  </select>
                  <button id="soundButton" onclick="playSound()" class="tower-button w-1/4">
                    Play
                  </button>
                </div>
              </fieldset>

              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Lights</legend>
                <div class="flex flex-wrap gap-4 py-2">
                  <fieldset class="nested-fieldset">
                    <legend class="tower-legend">Doorways:</legend>
                    <table class="text-center">
                      <thead>
                        <tr>
                          <td class="tower-table-header">N</td>
                          <td class="tower-table-header">E</td>
                          <td class="tower-table-header">S</td>
                          <td class="tower-table-header">W</td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="north" data-light-level="top" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="east" data-light-level="top" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="south" data-light-level="top" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="west" data-light-level="top" class="tower-checkbox" />
                          </td>
                        </tr>
                        <tr>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="north" data-light-level="middle" name="north"
                              class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="east" data-light-level="middle" name="east" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="south" data-light-level="middle" name="south"
                              class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="west" data-light-level="middle" name="west" class="tower-checkbox" />
                          </td>
                        </tr>
                        <tr>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="north" data-light-level="bottom" name="north"
                              class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="east" data-light-level="bottom" name="east" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="south" data-light-level="bottom" name="south"
                              class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="doorway"
                              data-light-location="west" data-light-level="bottom" name="west" class="tower-checkbox" />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </fieldset>
                  <fieldset class="nested-fieldset">
                    <legend class="tower-legend">Ledges:</legend>
                    <table class="text-center">
                      <thead>
                        <tr>
                          <td class="tower-table-header">N</td>
                          <td class="tower-table-header">E</td>
                          <td class="tower-table-header">S</td>
                          <td class="tower-table-header">W</td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="ledge"
                              data-light-location="north" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="ledge"
                              data-light-location="east" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="ledge"
                              data-light-location="south" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell">
                            <input type="checkbox" onclick="singleLight(this)" data-light-type="ledge"
                              data-light-location="west" class="tower-checkbox" />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </fieldset>
                  <fieldset class="nested-fieldset">
                    <legend class="tower-legend">Base:</legend>
                    <table class="text-sm">
                      <tbody>
                        <tr>
                          <td class="pr-2 py-1 font-bold">N</td>
                          <td class="tower-table-cell-sm">front</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="north" data-light-base-location="a" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell-sm">back</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="north" data-light-base-location="b" class="tower-checkbox" />
                          </td>
                        </tr>
                        <tr>
                          <td class="pr-2 py-1 font-bold">E</td>
                          <td class="tower-table-cell-sm">front</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="east" data-light-base-location="a" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell-sm">back</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="east" data-light-base-location="b" class="tower-checkbox" />
                          </td>
                        </tr>
                        <tr>
                          <td class="pr-2 py-1 font-bold">S</td>
                          <td class="tower-table-cell-sm">front</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="south" data-light-base-location="a" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell-sm">back</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="south" data-light-base-location="b" class="tower-checkbox" />
                          </td>
                        </tr>
                        <tr>
                          <td class="pr-2 py-1 font-bold">W</td>
                          <td class="tower-table-cell-sm">front</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="west" data-light-base-location="a" class="tower-checkbox" />
                          </td>
                          <td class="tower-table-cell-sm">back</td>
                          <td class="tower-table-cell-sm">
                            <input onclick="singleLight(this)" type="checkbox" data-light-type="base"
                              data-light-location="west" data-light-base-location="b" class="tower-checkbox" />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </fieldset>
                </div>
                <div style="margin-bottom: 1.5rem;"></div>
                <div class="p-1 flex flex-wrap gap-2 items-center">
                  <button id="light" onclick="lights()" class="tower-button w-40 whitespace-nowrap">Apply
                    to all lights</button>
                  <select id="lightStyles" class="tower-select w-40"></select>
                  <button id="allLightsOn" onclick="allLightsOn()" class="tower-button w-40 whitespace-nowrap">All
                    On</button>
                </div>
                <div class="p-1 flex flex-wrap gap-2 items-center">
                  <button id="lightOverrideButton" onclick="overrides()"
                    class="tower-button w-40 whitespace-nowrap">Light
                    Overrides</button>
                  <select id="lightOverrideDropDown" class="tower-select w-40">
                    <option value="0">select override</option>
                  </select>
                  <button id="allLightsOff" onclick="allLightsOff()" class="tower-button w-40 whitespace-nowrap">All
                    Off</button>
                </div>
              </fieldset>

              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Drums</legend>
                <div class="flex justify-center items-start p-1">
                  <div class="flex flex-col items-center space-y-2">
                    <div class="flex gap-5">
                      <select id="top" class="tower-select">
                        <option value="north">North</option>
                        <option value="south">South</option>
                        <option value="east">East</option>
                        <option value="west">West</option>
                      </select>
                      <select id="middle" class="tower-select">
                        <option value="north">North</option>
                        <option value="south">South</option>
                        <option value="east">East</option>
                        <option value="west">West</option>
                      </select>
                      <select id="bottom" class="tower-select">
                        <option value="north">North</option>
                        <option value="south">South</option>
                        <option value="east">East</option>
                        <option value="west">West</option>
                      </select>
                    </div>
                    <div class="flex justify-center">
                      <button id="rotateButton" onclick="rotate()" class="tower-button">Rotate</button>
                    </div>
                  </div>
                </div>
              </fieldset>

            </div>

            <!-- Library Tab Content -->
            <div id="library-content" class="tower-tab-content">
              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Drums</legend>
                <div class="flex justify-center items-center p-1 space-x-4">
                  <select id="randomLevels" class="tower-select">
                    <option value="-1">select level(s)</option>
                    <option value="0">all</option>
                    <option value="1">top</option>
                    <option value="2">middle</option>
                    <option value="3">bottom</option>
                    <option value="4">top & middle</option>
                    <option value="5">top & bottom</option>
                    <option value="6">middle & bottom</option>
                  </select>
                  <button id="randomizeButton" onclick="randomizeLevels()" class="tower-button">Randomize</button>
                </div>
              </fieldset>

              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Glyphs</legend>
                <div class="grid grid-cols-2 gap-4">
                  <!-- Left Column: Controls -->
                  <div class="space-y-4">
                    <div>
                      <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                          <label class="text-sm w-20">Glyph:</label>
                          <select id="glyph-select" class="tower-select flex-1">
                            <option value="">Select glyph</option>
                            <option value="cleanse">Cleanse</option>
                            <option value="quest">Quest</option>
                            <option value="battle">Battle</option>
                            <option value="banner">Banner</option>
                            <option value="reinforce">Reinforce</option>
                          </select>
                        </div>
                        <div class="flex items-center space-x-2">
                          <label class="text-sm w-20">Side:</label>
                          <select id="side-select" class="tower-select flex-1">
                            <option value="">Select side</option>
                            <option value="north">North</option>
                            <option value="east">East</option>
                            <option value="south">South</option>
                            <option value="west">West</option>
                          </select>
                        </div>
                        <button id="move-glyph-btn" onclick="moveGlyph()" class="tower-button w-full">
                          Move Glyph
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Right Column: Current Positions -->
                  <div>
                    <div id="current-glyph-positions" class="bg-gray-800 rounded p-3">
                      <!-- Grid headers -->
                      <div class="grid grid-cols-5 gap-1 mb-2 text-xs text-center">
                        <div></div>
                        <div class="font-semibold">N</div>
                        <div class="font-semibold">E</div>
                        <div class="font-semibold">S</div>
                        <div class="font-semibold">W</div>
                      </div>
                      <!-- Grid content -->
                      <div class="grid grid-cols-5 gap-1">
                        <!-- Top row -->
                        <div class="text-xs font-semibold flex items-center justify-center">Top</div>
                        <div id="glyph-top-north" class="glyph-cell" data-level="top" data-side="north"></div>
                        <div id="glyph-top-east" class="glyph-cell" data-level="top" data-side="east"></div>
                        <div id="glyph-top-south" class="glyph-cell" data-level="top" data-side="south"></div>
                        <div id="glyph-top-west" class="glyph-cell" data-level="top" data-side="west"></div>

                        <!-- Middle row -->
                        <div class="text-xs font-semibold flex items-center justify-center">Mid</div>
                        <div id="glyph-middle-north" class="glyph-cell" data-level="middle" data-side="north"></div>
                        <div id="glyph-middle-east" class="glyph-cell" data-level="middle" data-side="east"></div>
                        <div id="glyph-middle-south" class="glyph-cell" data-level="middle" data-side="south"></div>
                        <div id="glyph-middle-west" class="glyph-cell" data-level="middle" data-side="west"></div>

                        <!-- Bottom row -->
                        <div class="text-xs font-semibold flex items-center justify-center">Bot</div>
                        <div id="glyph-bottom-north" class="glyph-cell" data-level="bottom" data-side="north"></div>
                        <div id="glyph-bottom-east" class="glyph-cell" data-level="bottom" data-side="east"></div>
                        <div id="glyph-bottom-south" class="glyph-cell" data-level="bottom" data-side="south"></div>
                        <div id="glyph-bottom-west" class="glyph-cell" data-level="bottom" data-side="west"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </fieldset>

              <fieldset class="tower-fieldset">
                <legend class="tower-legend">Break Seal</legend>
                <div class="flex justify-between items-start p-1">
                  <!-- Left side: Controls -->
                  <div class="flex-1 flex justify-center">
                    <div class="flex flex-col space-y-2">
                      <!-- Dropdown -->
                      <select id="sealSelect" class="tower-select w-55">
                        <option value="">Select a Location</option>
                        <option value="North Top">North Top</option>
                        <option value="North Middle">North Middle</option>
                        <option value="North Bottom">North Bottom</option>
                        <option value="East Top">East Top</option>
                        <option value="East Middle">East Middle</option>
                        <option value="East Bottom">East Bottom</option>
                        <option value="South Top">South Top</option>
                        <option value="South Middle">South Middle</option>
                        <option value="South Bottom">South Bottom</option>
                        <option value="West Top">West Top</option>
                        <option value="West Middle">West Middle</option>
                        <option value="West Bottom">West Bottom</option>
                      </select>
                      <!-- Buttons -->
                      <div class="flex justify-center items-center space-x-2">
                        <button id="breakSealButton" onclick="breakSeal()" class="tower-button">
                          Break Seal
                        </button>
                        <button id="clearLightsButton" onclick="clearAllLights()" class="tower-button">
                          Clear Effect
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- Right side: Seal Status Grid -->
                  <div class="flex-1 flex justify-center">
                    <div class="seal-grid">
                      <!-- Top Row -->
                      <div class="seal-square" data-seal-level="top" data-seal-side="north" title="North Top Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="top" data-seal-side="east" title="East Top Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="top" data-seal-side="south" title="South Top Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="top" data-seal-side="west" title="West Top Seal"
                        onclick="sealSquareClick(this)"></div>
                      <!-- Middle Row -->
                      <div class="seal-square" data-seal-level="middle" data-seal-side="north" title="North Middle Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="middle" data-seal-side="east" title="East Middle Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="middle" data-seal-side="south" title="South Middle Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="middle" data-seal-side="west" title="West Middle Seal"
                        onclick="sealSquareClick(this)"></div>
                      <!-- Bottom Row -->
                      <div class="seal-square" data-seal-level="bottom" data-seal-side="north" title="North Bottom Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="bottom" data-seal-side="east" title="East Bottom Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="bottom" data-seal-side="south" title="South Bottom Seal"
                        onclick="sealSquareClick(this)"></div>
                      <div class="seal-square" data-seal-level="bottom" data-seal-side="west" title="West Bottom Seal"
                        onclick="sealSquareClick(this)"></div>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>

          <!-- Right Column -->
          <div class="space-y-3">
            <fieldset class="tower-fieldset">
              <legend class="tower-legend">Tower Status</legend>
              <div class="flex justify-evenly items-baseline p-1">
                <div class="text-center">
                  <label class="block mb-2">Battery Level</label>
                  <div class="flex justify-center items-center space-x-2">
                    <span id="battery">Unknown</span>
                    <span id="batteryTrend">
                    </span>
                  </div>
                </div>
                <div class="text-center">
                  <div class="border border-white rounded px-2 py-1 mb-2">Skulls Dropped:&nbsp;&nbsp;<span
                      id="skull-count">unknown</span></div>
                  <button id="reset" onclick="resetSkullCount()" class="tower-button">Reset
                    Count</button>
                </div>
              </div>
            </fieldset>

            <fieldset class="tower-fieldset flex flex-col h-[500px]">
              <legend class="tower-legend">Log</legend>
              <div class="flex justify-between items-center">
                <div class="grid grid-cols-3 gap-x-4 gap-y-2 flex-1 mr-4 items-end">
                  <div class="flex flex-col space-y-2">
                    <div class="flex items-center space-x-1">
                      <input type="checkbox" id="logLevel-info" value="info" onchange="updateLogLevel()" checked
                        class="tower-checkbox" />
                      <label for="logLevel-info" class="text-white uppercase tracking-wider text-xs">Info</label>
                      <span class="inline-block w-3 h-3 ml-1"
                        style="background-color: #3b82f6; border: 1px solid #1f2937;"></span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <input type="checkbox" id="logLevel-error" value="error" onchange="updateLogLevel()" checked
                        class="tower-checkbox" />
                      <label for="logLevel-error" class="text-white uppercase tracking-wider text-xs">Error</label>
                      <span class="inline-block w-3 h-3 ml-1"
                        style="background-color: #ef4444; border: 1px solid #b91c1c;"></span>
                    </div>
                  </div>
                  <div class="flex flex-col space-y-2">
                    <div class="flex items-center space-x-1">
                      <input type="checkbox" id="logLevel-warn" value="warn" onchange="updateLogLevel()" checked
                        class="tower-checkbox" />
                      <label for="logLevel-warn" class="text-white uppercase tracking-wider text-xs">Warn</label>
                      <span class="inline-block w-3 h-3 ml-1"
                        style="background-color: #f97316; border: 1px solid #c2410c;"></span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <input type="checkbox" id="logLevel-debug" value="debug" onchange="updateLogLevel()" checked
                        class="tower-checkbox" />
                      <label for="logLevel-debug" class="text-white uppercase tracking-wider text-xs">Debug</label>
                      <span class="inline-block w-3 h-3 ml-1"
                        style="background-color: #9ca3af; border: 1px solid #6b7280;"></span>
                    </div>
                  </div>
                  <div class="flex flex-col space-y-1">
                    <span class="text-white uppercase tracking-wider text-xs">Battery:</span>
                    <div class="flex flex-col space-y-1">
                      <div class="flex items-center space-x-1">
                        <input type="radio" id="batteryAll" name="batteryFilter" value="all"
                          onchange="updateBatteryFilter()" class="tower-checkbox" />
                        <label for="batteryAll" class="text-white uppercase tracking-wider text-xs">All</label>
                      </div>
                      <div class="flex items-center space-x-1">
                        <input type="radio" id="batteryChanges" name="batteryFilter" value="changes"
                          onchange="updateBatteryFilter()" checked class="tower-checkbox" />
                        <label for="batteryChanges" class="text-white uppercase tracking-wider text-xs">Changes</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-2"></div>
              <div id="log-container"
                class="flex-1 overflow-y-auto border border-gray-400 p-2 font-mono text-xs bg-gray-100 text-black rounded-md">
              </div>
              <div class="mt-2 flex gap-2">
                <input type="text" id="logTextFilter" placeholder="Filter log messages..." onkeyup="updateLogLevel()"
                  class="flex-1 tower-select placeholder-gray-400" />
                <span id="logBufferSize" class="text-gray-400 text-sm px-2 py-1.5 whitespace-nowrap">0/0</span>
                <button onclick="copyDisplayedLogs(event)" title="Copy displayed logs to clipboard"
                  class="tower-button">
                  <i class="fas fa-copy"></i>
                </button>
                <button onclick="downloadDisplayedLogs(event)" title="Download displayed logs to file"
                  class="tower-button">
                  <i class="fas fa-file-arrow-down"></i>
                </button>
                <button onclick="clearLog()" class="tower-button">
                  Clear Log
                </button>
              </div>
            </fieldset>
          </div>
        </div>

        <hr class="tower-hr" />
        <div class="pb-1 text-center">
          Come join us on the
          <a target="_blank" href="https://discord.com/invite/87kffaR3jV" class="tower-link">
            Ultimate Dark Tower Discord Server!
          </a>
          <hr class="tower-hr" />
          Note: Web Bluetooth is not yet supported in Safari, Firefox or mobile. See <a target="_blank"
            href="https://caniuse.com/?search=web%20bluetooth" class="tower-link">support
            matrix</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    const updateBatteryFilter = () => {
      const batteryFilterRadios = document.querySelectorAll('input[name="batteryFilter"]');
      const selectedValue = Array.from(batteryFilterRadios).find(radio => radio.checked)?.value;

      if (selectedValue && window.Tower) {
        // Update the tower's battery notification setting
        // 'all' = false (show all notifications), 'changes' = true (only show changes)
        window.Tower.batteryNotifyOnValueChangeOnly = selectedValue === 'changes';

        // Log the change for debugging
        console.log('Battery filter set to:', selectedValue);
      }
    }

    // Log control functions
    const updateLogLevel = () => {
      if (window.logger) {
        const checkboxes = document.querySelectorAll('input[id^="logLevel-"]');
        const selectedLevels = Array.from(checkboxes)
          .filter(checkbox => checkbox.checked)
          .map(checkbox => checkbox.value);

        if (selectedLevels.length > 0) {
          window.logger.setEnabledLevels(selectedLevels);
        } else {
          // Default to 'all' if nothing is selected
          window.logger.setEnabledLevels(['all']);
        }
      }

      // Refresh DOM output filtering (includes text filter)
      if (window.sharedDOMOutput) {
        window.sharedDOMOutput.refreshFilter();
      }
    }

    const clearLog = () => {
      // Clear shared DOM output
      if (window.sharedDOMOutput) {
        window.sharedDOMOutput.clearAll();
      }

      // Fallback to direct container clearing
      const container = document.getElementById("log-container");
      if (container) {
        container.innerHTML = '';
      }

      // Clear the text filter input
      const textFilter = document.getElementById("logTextFilter");
      if (textFilter) {
        textFilter.value = '';
      }
    }

    const copyDisplayedLogs = (event) => {
      const logContainer = document.getElementById("log-container");
      if (!logContainer) return;

      // Get all currently displayed log entries
      const logLines = logContainer.querySelectorAll('.log-line');
      if (logLines.length === 0) {
        alert('No log entries to copy');
        return;
      }

      // Extract text content from each log line
      const logText = Array.from(logLines)
        .map(line => line.textContent || '')
        .join('\n');

      // Copy to clipboard
      navigator.clipboard.writeText(logText).then(() => {
        // Optional: Show temporary success feedback
        const button = event.target.closest('button');
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.style.backgroundColor = '#10b981';

        setTimeout(() => {
          button.innerHTML = originalIcon;
          button.style.backgroundColor = '';
        }, 1000);
      }).catch(err => {
        console.error('Failed to copy logs: ', err);
        alert('Failed to copy logs to clipboard');
      });
    }

    const downloadDisplayedLogs = (event) => {
      const logContainer = document.getElementById("log-container");
      if (!logContainer) return;

      // Get all currently displayed log entries
      const logLines = logContainer.querySelectorAll('.log-line');
      if (logLines.length === 0) {
        alert('No log entries to download');
        return;
      }

      // Extract text content from each log line
      const logText = Array.from(logLines)
        .map(line => line.textContent || '')
        .join('\n');

      // Create header with current date and time
      const now = new Date();
      const dateStr = now.toLocaleDateString();
      const timeStr = now.toLocaleTimeString();
      const header = `UltimateDarkTower Log Output - ${dateStr} ${timeStr}\n${'-'.repeat(60)}\n`;

      // Combine header with log content
      const fileContent = header + logText;

      // Create a blob with the log content
      const blob = new Blob([fileContent], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);

      // Create a temporary anchor element for download
      const a = document.createElement('a');
      a.href = url;
      a.download = 'TowerLog.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      // Show temporary success feedback
      const button = event.target.closest('button');
      const originalIcon = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i>';
      button.style.backgroundColor = '#10b981';

      setTimeout(() => {
        button.innerHTML = originalIcon;
        button.style.backgroundColor = '';
      }, 1000);
    }


    // populate dropdowns
    const dropDowns = [
      { "sounds": TOWER_AUDIO_LIBRARY },
      { "lightOverrideDropDown": TOWER_LIGHT_SEQUENCES },
      { "lightStyles": LIGHT_EFFECTS }
    ];

    dropDowns.forEach(item => {
      const id = Object.keys(item)[0];
      const data = Object.values(item)[0];
      let dropDown = document.getElementById(id);

      if (id === 'sounds') {
        // Special handling for sounds dropdown to use actual sound values and names
        Object.keys(data).forEach(key => {
          var el = document.createElement("option");
          el.textContent = data[key].name;
          el.value = data[key].value;
          dropDown.appendChild(el);
        });
      } else {
        // Original logic for other dropdowns
        const keys = Object.keys(data);
        keys.forEach((value, index) => {
          var el = document.createElement("option");
          el.textContent = value;
          el.value = index + 1;
          dropDown.appendChild(el);
        });
      }
    });

    // Expose copy and download functions globally for HTML onclick handlers
    window.copyDisplayedLogs = copyDisplayedLogs;
    window.downloadDisplayedLogs = downloadDisplayedLogs;
    window.updateBatteryFilter = updateBatteryFilter;

    // Tab switching functionality
    const switchTab = (tabName) => {
      // Remove active class from all tab buttons
      document.querySelectorAll('.tower-tab-button').forEach(button => {
        button.classList.remove('tower-tab-active');
      });

      // Hide all tab content
      document.querySelectorAll('.tower-tab-content').forEach(content => {
        content.classList.remove('tower-tab-content-active');
      });

      // Activate the selected tab button
      document.getElementById(tabName + '-tab').classList.add('tower-tab-active');

      // Show the selected tab content
      document.getElementById(tabName + '-content').classList.add('tower-tab-content-active');

      // Auto-refresh glyph positions when switching to library tab (since glyphs are now there)
      if (tabName === 'library') {
        setTimeout(refreshGlyphPositions, 100);
      }
    }

    // Expose switchTab function globally for HTML onclick handlers
    window.switchTab = switchTab;

    // Initialize battery filter on page load
    document.addEventListener('DOMContentLoaded', () => {
      updateBatteryFilter();
    });

    // Glyph management functions
    const getGlyphsFacingDirection = (direction) => {
      try {
        return Tower.getGlyphsFacingDirection(direction);
      } catch (error) {
        console.error('Error getting glyphs facing direction:', error);
        window.logger.error('Error getting glyphs facing direction: ' + error.message, '[Glyphs]');
        return [];
      }
    };

    const refreshGlyphPositions = async () => {
      try {
        const positions = await Tower.getAllGlyphPositions();

        // Clear all glyph cells first
        const allCells = document.querySelectorAll('.glyph-cell');
        allCells.forEach(cell => {
          cell.innerHTML = '';
          cell.style.backgroundColor = '#4b5563';
        });

        // Map of glyph names to their SVG file paths
        const glyphSvgMap = {
          'cleanse': '../assets/glyph_cleanse.svg',
          'quest': '../assets/glyph_quest.svg',
          'battle': '../assets/glyph_battle.svg',
          'banner': '../assets/glyph_banner.svg',
          'reinforce': '../assets/glyph_reinforce.svg'
        };

        // Update the display for each glyph
        Object.entries(positions).forEach(([glyph, position]) => {
          if (position && position !== 'unknown') {
            // Get the glyph's fixed level based on its type
            const glyphLevels = {
              'cleanse': 'top',
              'quest': 'top',
              'battle': 'middle',
              'banner': 'bottom',
              'reinforce': 'bottom'
            };

            const level = glyphLevels[glyph];
            const cellId = `glyph-${level}-${position}`;
            const cell = document.getElementById(cellId);

            if (cell && glyphSvgMap[glyph]) {
              const img = document.createElement('img');
              img.src = glyphSvgMap[glyph];
              img.alt = glyph;
              img.title = `${glyph.charAt(0).toUpperCase() + glyph.slice(1)} (${position})`;
              cell.appendChild(img);
              cell.style.backgroundColor = '#374151'; // Slightly lighter for occupied cells
            }
          }
        });
      } catch (error) {
        console.error('Error refreshing glyph positions:', error);
        window.logger.error('Error refreshing glyph positions: ' + error.message, '[Glyphs]');
      }
    };

    const moveGlyph = async () => {
      const glyphSelect = document.getElementById('glyph-select');
      const sideSelect = document.getElementById('side-select');

      const selectedGlyph = glyphSelect.value;
      const targetSide = sideSelect.value;

      if (!selectedGlyph || !targetSide) {
        window.logger.warn('Please select a glyph and target side', '[Glyphs]');
        return;
      }

      try {
        // Get current glyph positions
        const currentPositions = await Tower.getAllGlyphPositions();
        const currentGlyphPosition = currentPositions[selectedGlyph];

        if (!currentGlyphPosition) {
          window.logger.error(`Unable to find current position for ${selectedGlyph} glyph, please perform a calibration first.`, '[Glyphs]');
          return;
        }

        // Get the fixed level for this glyph (glyphs can't change levels)
        const glyphDefinitions = {
          cleanse: { level: 'top', side: 'north' },
          quest: { level: 'top', side: 'south' },
          battle: { level: 'middle', side: 'north' },
          banner: { level: 'bottom', side: 'north' },
          reinforce: { level: 'bottom', side: 'south' }
        };

        const glyphLevel = glyphDefinitions[selectedGlyph].level;

        // Calculate rotation needed to move glyph to target position
        const sides = ['north', 'east', 'south', 'west'];
        const currentSideIndex = sides.indexOf(currentGlyphPosition);
        const targetSideIndex = sides.indexOf(targetSide);

        if (currentSideIndex === -1 || targetSideIndex === -1) {
          window.logger.error('Invalid current or target side', '[Glyphs]');
          return;
        }

        // Calculate clockwise rotation steps needed
        let rotationSteps = (targetSideIndex - currentSideIndex + 4) % 4;

        if (rotationSteps === 0) {
          window.logger.info(`${selectedGlyph} glyph is already at ${targetSide} position`, '[Glyphs]');
          return;
        }

        // Calculate what drum position will put the selected glyph at the target side
        let targetDrumPosition;
        if (glyphLevel === 'top' || glyphLevel === 'middle' || glyphLevel === 'bottom') {
          // Calculate the drum position needed to put this specific glyph at the target side
          const currentDrumPosition = Tower.getCurrentDrumPosition(glyphLevel);
          const sides = ['north', 'east', 'south', 'west'];

          const currentDrumIndex = sides.indexOf(currentDrumPosition);
          const currentGlyphIndex = sides.indexOf(currentGlyphPosition);
          const targetGlyphIndex = sides.indexOf(targetSide);

          // Calculate how many steps the glyph needs to move
          let glyphSteps = (targetGlyphIndex - currentGlyphIndex + 4) % 4;

          // Calculate the new drum position
          const newDrumIndex = (currentDrumIndex + glyphSteps) % 4;
          targetDrumPosition = sides[newDrumIndex];
        }

        // Set positions for all three drums
        const topPosition = glyphLevel === 'top' ? targetDrumPosition : Tower.getCurrentDrumPosition('top');
        const middlePosition = glyphLevel === 'middle' ? targetDrumPosition : Tower.getCurrentDrumPosition('middle');
        const bottomPosition = glyphLevel === 'bottom' ? targetDrumPosition : Tower.getCurrentDrumPosition('bottom');

        window.logger.info(`Moving ${selectedGlyph} glyph from ${currentGlyphPosition} to ${targetSide} by rotating ${glyphLevel} level (${rotationSteps} steps clockwise)`, '[Glyphs]');

        // Execute the rotation with all three drum positions
        await Tower.Rotate(topPosition, middlePosition, bottomPosition);

        // Refresh glyph positions after rotation
        setTimeout(refreshGlyphPositions, 1000);

        window.logger.info(`Successfully moved ${selectedGlyph} glyph to ${targetSide} position`, '[Glyphs]');

      } catch (error) {
        console.error('Error moving glyph:', error);
        window.logger.error('Error moving glyph: ' + error.message, '[Glyphs]');
      }
    };

    // Expose glyph functions globally
    window.getGlyphsFacingDirection = getGlyphsFacingDirection;
    window.refreshGlyphPositions = refreshGlyphPositions;
    window.moveGlyph = moveGlyph;
  </script>
</body>

</html>